{% extends "layout.html" %}

{% block title %}Recurring Events Scheduler{% endblock %}

{% block content %}
<div class="container my-4">
    <h2>Recurring & Special Events Scheduler</h2>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Add Recurring Event</h4>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('add_recurring_event') }}" method="post">
                        <div class="mb-3">
                            <label for="name" class="form-label">Event Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="teacher_id" class="form-label">Teacher</label>
                            <select class="form-control" id="teacher_id" name="teacher_id">
                                <option value="">-- Select Teacher (Optional) --</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="classroom_id" class="form-label">Room</label>
                            <select class="form-control" id="classroom_id" name="classroom_id" required>
                                <option value="">-- Select Room --</option>
                                {% for room in classrooms %}
                                <option value="{{ room.id }}">{{ room.name }} (Capacity: {{ room.capacity }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="day" class="form-label">Day of Week</label>
                            <select class="form-control" id="day" name="day" required>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="start_time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="start_time" name="start_time" required>
                            </div>
                            <div class="col">
                                <label for="end_time" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="end_time" name="end_time" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="recurrence_type" class="form-label">Recurrence Type</label>
                            <select class="form-control" id="recurrence_type" name="recurrence_type" required>
                                <option value="weekly">Weekly</option>
                                <option value="daily">Daily</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                            </div>
                            <div class="col">
                                <label for="end_date" class="form-label">End Date (Optional)</label>
                                <input type="date" class="form-control" id="end_date" name="end_date">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Recurring Event</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4>Add Special Event</h4>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('add_special_event') }}" method="post">
                        <div class="mb-3">
                            <label for="sp_name" class="form-label">Event Name</label>
                            <input type="text" class="form-control" id="sp_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="sp_description" class="form-label">Description</label>
                            <textarea class="form-control" id="sp_description" name="description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="sp_teacher_id" class="form-label">Teacher</label>
                            <select class="form-control" id="sp_teacher_id" name="teacher_id">
                                <option value="">-- Select Teacher (Optional) --</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sp_classroom_id" class="form-label">Room</label>
                            <select class="form-control" id="sp_classroom_id" name="classroom_id" required>
                                <option value="">-- Select Room --</option>
                                {% for room in classrooms %}
                                <option value="{{ room.id }}">{{ room.name }} (Capacity: {{ room.capacity }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sp_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="sp_date" name="date" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="sp_start_time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="sp_start_time" name="start_time" required>
                            </div>
                            <div class="col">
                                <label for="sp_end_time" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="sp_end_time" name="end_time" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Add Special Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4>Upcoming Events</h4>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="eventTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="recurring-tab" data-bs-toggle="tab" data-bs-target="#recurring-events" type="button" role="tab" aria-controls="recurring-events" aria-selected="true">Recurring Events</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="special-tab" data-bs-toggle="tab" data-bs-target="#special-events" type="button" role="tab" aria-controls="special-events" aria-selected="false">Special Events</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="eventTabContent">
                        <div class="tab-pane fade show active" id="recurring-events" role="tabpanel" aria-labelledby="recurring-tab">
                            {% if recurring_events %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Room</th>
                                                <th>Teacher</th>
                                                <th>Day</th>
                                                <th>Time</th>
                                                <th>Recurrence</th>
                                                <th>Period</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for event in recurring_events %}
                                            <tr>
                                                <td>{{ event.name }}</td>
                                                <td>{{ event.classroom.name }}</td>
                                                <td>{{ event.teacher.name if event.teacher else '-' }}</td>
                                                <td>{{ event.day }}</td>
                                                <td>{{ event.start_time }} - {{ event.end_time }}</td>
                                                <td>{{ event.recurrence_type.value }}</td>
                                                <td>{{ event.start_date.strftime('%d %b %Y') }} - {{ event.end_date.strftime('%d %b %Y') if event.end_date else 'Ongoing' }}</td>
                                                <td>
                                                    <form action="{{ url_for('delete_recurring_event', id=event.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this recurring event?')">
                                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">No recurring events scheduled.</div>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="special-events" role="tabpanel" aria-labelledby="special-tab">
                            {% if special_events %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Room</th>
                                                <th>Teacher</th>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for event in special_events %}
                                            <tr>
                                                <td>{{ event.name }}</td>
                                                <td>{{ event.classroom.name }}</td>
                                                <td>{{ event.teacher.name if event.teacher else '-' }}</td>
                                                <td>{{ event.date.strftime('%d %b %Y') }}</td>
                                                <td>{{ event.start_time }} - {{ event.end_time }}</td>
                                                <td>
                                                    <form action="{{ url_for('delete_special_event', id=event.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this special event?')">
                                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">No special events scheduled.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today as the default for date fields
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start_date').value = today;
    document.getElementById('sp_date').value = today;
    
    // Validate end time is after start time
    function validateTimes(startTime, endTime, formId) {
        if (startTime >= endTime) {
            alert('End time must be after start time');
            return false;
        }
        return true;
    }
    
    // Add event listeners for form submission
    const recurringForm = document.querySelector('form[action="' + "{{ url_for('add_recurring_event') }}" + '"]');
    if (recurringForm) {
        recurringForm.addEventListener('submit', function(e) {
            const startTime = document.getElementById('start_time').value;
            const endTime = document.getElementById('end_time').value;
            if (!validateTimes(startTime, endTime, 'recurring')) {
                e.preventDefault();
            }
        });
    }
    
    const specialForm = document.querySelector('form[action="' + "{{ url_for('add_special_event') }}" + '"]');
    if (specialForm) {
        specialForm.addEventListener('submit', function(e) {
            const startTime = document.getElementById('sp_start_time').value;
            const endTime = document.getElementById('sp_end_time').value;
            if (!validateTimes(startTime, endTime, 'special')) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
